name: myerp CI/CD

on:
  push:
    branches: [ "develop" ]
    paths:
      - "server/**"
      - ".github/workflows/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    env:
      APP_IMAGE: imline/myerp
      TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build (Maven)
        run: |
          if [ -x ./mvnw ]; then chmod +x ./mvnw; ./mvnw -B -DskipTests package;
          else mvn -B -DskipTests package; fi

      - name: Docker Hub login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Build & Push image
        run: |
          docker build -f Dockerfile -t $APP_IMAGE:latest -t $APP_IMAGE:$TAG .
          docker push $APP_IMAGE:$TAG
          docker push $APP_IMAGE:latest

      - name: Ensure target dir on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p /opt/myerp
            sudo chown -R ubuntu:ubuntu /opt/myerp

      - name: Upload compose & nginx to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "server/docker-compose.yml,server/nginx/**"
          target: "/opt/myerp"
          strip_components: 1    # ← server/ 접두어 제거

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /opt/myerp

            # 0) Docker 로그인(프라이빗 레포 대비)
            echo '${{ secrets.DOCKERHUB_TOKEN }}' | docker login -u '${{ secrets.DOCKERHUB_USER }}' --password-stdin || true

            # 1) 런타임 환경변수(이 셸 세션에서만 유효; compose가 그대로 읽음)
            export ORACLE_PASSWORD='${{ secrets.ORACLE_SYS_PASSWORD }}'
            export DB_USERNAME='${{ secrets.DB_USER }}'
            export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            export CORS_ALLOWED_ORIGIN='https://api.myerp.proup.site'
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'

            # 2) 이미지/볼륨 준비
            docker volume create myerp_oracle_data || true
            docker compose pull || true

            # 3) 오라클 먼저 올리고 health 대기(최대 10분)
            docker compose up -d oracle
            echo "⏳ waiting oracle-xe to be healthy (max 10m)"
            ok=""
            for i in {1..60}; do
              state=$(docker inspect -f '{{.State.Health.Status}}' oracle-xe 2>/dev/null || echo "unknown")
              echo "  -> health: $state"
              if [ "$state" = "healthy" ]; then ok="yes"; break; fi
              sleep 10
            done
            if [ "$ok" != "yes" ]; then
              echo "❌ oracle-xe not healthy"; docker compose logs --no-color --tail=200 oracle || true; exit 1
            fi

            # 4) 앱/엔진엑스 기동
            docker compose up -d app nginx

            # 5) Nginx 체크 & 재로드(있으면)
            docker compose exec -T nginx nginx -t && docker compose exec -T nginx nginx -s reload || true

            # 6) 상태 확인
            docker compose ps


