name: myerp CI/CD

on:
  push:
    branches: [ "develop" ]
    paths:
      - "server/**"
      - ".github/workflows/**"   # 워크플로 수정 시에도 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      APP_IMAGE: imline/myerp
      TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build (Gradle)
        run: ./gradlew clean bootJar

      # ---- Docker Hub: login, build, push ----
      - name: Docker Hub login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Build & Push image
        run: |
          docker build -t $APP_IMAGE:latest -t $APP_IMAGE:$TAG .
          docker push $APP_IMAGE:$TAG
          docker push $APP_IMAGE:latest

      # ---- compose/nginx를 EC2로 업로드 ----
      - name: Upload compose & nginx to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml,nginx/**"
          target: "/opt/myerp"

      # ---- Deploy on EC2: pull & compose up ----
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /opt/myerp

            echo '${{ secrets.DOCKERHUB_TOKEN }}' | docker login -u '${{ secrets.DOCKERHUB_USER }}' --password-stdin || true

            export ORACLE_PASSWORD='${{ secrets.ORACLE_SYS_PASSWORD }}'
            export DB_USERNAME='${{ secrets.DB_USER }}'
            export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            export CORS_ALLOWED_ORIGIN='https://myerp.proup.site'
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'

            docker volume create myerp_oracle_data || true
            docker compose pull app || true
            docker compose up -d

            # Nginx 설정 리로드(있으면 통과, 없으면 무시)
            docker compose exec -T nginx nginx -t && docker compose exec -T nginx nginx -s reload || true

            docker image prune -f || true
