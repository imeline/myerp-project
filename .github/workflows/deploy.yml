name: myerp CI/CD

on:
  push:
    branches: [ "develop" ]
    paths:
      - "server/**"
      - ".github/workflows/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    env:
      APP_IMAGE: imline/myerp
      TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build (Maven)
        run: |
          if [ -x ./mvnw ]; then chmod +x ./mvnw; ./mvnw -B -DskipTests package;
          else mvn -B -DskipTests package; fi

      - name: Docker Hub login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Build & Push image
        run: |
          docker build -f Dockerfile -t $APP_IMAGE:latest -t $APP_IMAGE:$TAG .
          docker push $APP_IMAGE:$TAG
          docker push $APP_IMAGE:latest

      - name: Ensure target dir on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p /opt/myerp
            sudo chown -R ubuntu:ubuntu /opt/myerp

      - name: Upload compose & nginx to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "server/docker-compose.yml,server/nginx/**"
          target: "/opt/myerp"
          strip_components: 1    # ← server/ 접두어 제거

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        env:
          ORACLE_PASSWORD:       ${{ secrets.ORACLE_SYS_PASSWORD }}
          DB_USERNAME:           ${{ secrets.DB_USER }}
          DB_PASSWORD:           ${{ secrets.DB_PASSWORD }}
          JWT_SECRET:            ${{ secrets.JWT_SECRET }}
          CORS_ALLOWED_ORIGIN:   ${{ secrets.CORS_ALLOWED_ORIGIN }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: ORACLE_PASSWORD,DB_USERNAME,DB_PASSWORD,JWT_SECRET,CORS_ALLOWED_ORIGIN
          script: |
            set -e
            cd /opt/myerp

            # 새 설정 반영 위해 항상 재생성
            docker compose down || true

            # 볼륨(없으면 생성)
            docker volume create myerp_oracle_data || true

            # 오라클 먼저 띄우기
            docker compose up -d --force-recreate --remove-orphans oracle

            # 헬스 대기 (최대 10분)
            ok=""; for i in {1..60}; do
              s=$(docker inspect -f '{{.State.Health.Status}}' oracle-xe 2>/dev/null || echo "unknown")
              echo "oracle-xe: $s"
              [ "$s" = "healthy" ] && ok="yes" && break
              sleep 10
            done
            [ "$ok" = "yes" ] || { echo "❌ oracle not healthy"; docker compose logs --no-color --tail=200 oracle || true; exit 1; }

            # 앱/엔진엑스
            docker compose up -d --force-recreate app nginx

            # Nginx 테스트 & 재로드(있으면)
            docker compose exec -T nginx nginx -t && docker compose exec -T nginx nginx -s reload || true

            docker compose ps
      

