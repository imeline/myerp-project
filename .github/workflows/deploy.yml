name: myerp CI/CD

on:
  push:
    branches: [ "develop" ]
    paths:
      - "server/**"
      - ".github/workflows/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    env:
      APP_IMAGE: imline/myerp
      TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build (Maven)
        run: |
          if [ -x ./mvnw ]; then chmod +x ./mvnw; ./mvnw -B -DskipTests package;
          else mvn -B -DskipTests package; fi

      - name: Docker Hub login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      - name: Build & Push image
        run: |
          docker build -f Dockerfile -t $APP_IMAGE:latest -t $APP_IMAGE:$TAG .
          docker push $APP_IMAGE:$TAG
          docker push $APP_IMAGE:latest

      - name: Upload compose & nginx to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "../docker-compose.yml,../nginx/**"
          target: "/opt/myerp"

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /opt/myerp
            echo '${{ secrets.DOCKERHUB_TOKEN }}' | docker login -u '${{ secrets.DOCKERHUB_USER }}' --password-stdin || true
            export ORACLE_PASSWORD='${{ secrets.ORACLE_SYS_PASSWORD }}'
            export DB_USERNAME='${{ secrets.DB_USER }}'
            export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            export CORS_ALLOWED_ORIGIN='https://api.myerp.proup.site'
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'
            docker volume create myerp_oracle_data || true
            docker compose up -d oracle
            sleep 90
            docker compose pull app || true
            docker compose up -d
            docker compose exec -T nginx nginx -t && docker compose exec -T nginx nginx -s reload || true
            docker compose ps
