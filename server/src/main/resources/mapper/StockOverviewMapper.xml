<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.report.stock.overview.mapper.StockOverviewMapper">

    <select id="findStockOverviewRow" resultType="StockOverviewRow">
        SELECT
        /* 1) 삭제되지 않은 품목 종류 수 */
        (SELECT COUNT(1)
        FROM item i
        WHERE i.deleted_at IS NULL
        AND
        <include refid="frag.tenantGuardAlias">
            <property name="alias" value="i"/>
        </include>
        ) AS totalItemCount,

        /* 2) CONFIRMED 상태(= 입고 예정) 발주 수 */
        (SELECT COUNT(1)
        FROM purchase p
        WHERE p.status = 'CONFIRMED'
        AND
        <include refid="frag.tenantGuardAlias">
            <property name="alias" value="p"/>
        </include>
        ) AS confirmedPurchaseCount,

        /* 3) 가용재고(on_hand - allocated) = 0 인 품목 수 */
        (SELECT COUNT(1) FROM (
        SELECT i.item_id
        FROM item i
        LEFT JOIN stock s
        ON s.item_id = i.item_id
        WHERE i.deleted_at IS NULL
        AND
        <include refid="frag.tenantGuardAlias">
            <property name="alias" value="i"/>
        </include>
        AND
        <include refid="frag.tenantGuardAlias">
            <property name="alias" value="s"/>
        </include>
        GROUP BY i.item_id
        HAVING (NVL(SUM(s.on_hand_quantity), 0) - NVL(SUM(s.allocated_quantity),
        0)) = 0
        )) AS zeroAvailableItemCount,

        /* 4) 총 재고가치 = Σ(on_hand × 단가) */
        (SELECT NVL(SUM(NVL(s.on_hand_quantity, 0) * i.price), 0)
        FROM item i
        JOIN stock s
        ON s.item_id = i.item_id
        WHERE i.deleted_at IS NULL
        AND
        <include refid="frag.tenantGuardAlias">
            <property name="alias" value="i"/>
        </include>
        AND
        <include refid="frag.tenantGuardAlias">
            <property name="alias" value="s"/>
        </include>
        ) AS totalInventoryValue
        FROM dual
    </select>
</mapper>
