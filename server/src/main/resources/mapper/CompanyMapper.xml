<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.company.mapper.CompanyMapper">
    <select id="nextId" resultType="long">
        SELECT COMPANY_SEQ.NEXTVAL
        FROM DUAL
    </select>

    <insert id="save" parameterType="Company">
        INSERT INTO company (company_id, name, biz_no, address, phone)
        VALUES (#{companyId}, #{name}, #{bizNo}, #{address}, #{phone})
    </insert>

    <update id="updateById" parameterType="Company">
        UPDATE company
        SET name    = #{name},
            biz_no  = #{bizNo},
            address = #{address},
            phone   = #{phone}
        WHERE company_id = #{companyId}
    </update>

    <select id="findById" resultType="Company">
        SELECT *
        FROM company
        WHERE company_id = #{companyId}
          AND deleted_at IS NULL
    </select>

    <select id="findAllCompanyRow" resultType="CompanyFindRow">
        SELECT
        company_id AS companyId,
        name AS name,
        biz_no AS bizNo,
        address AS address,
        phone AS phone,
        TO_CHAR(created_at, 'YYYY.MM.DD') AS createdAt
        FROM company
        WHERE 1=1
        <if test="name != null and name != ''">
            AND INSTR(LOWER(name), LOWER(#{name})) > 0
        </if>
        AND deleted_at IS NULL
        ORDER BY created_at DESC, company_id DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <select id="countByName" resultType="long">
        SELECT COUNT(*)
        FROM company
        WHERE 1=1
        <if test="name != null and name != ''">
            AND INSTR(LOWER(name), LOWER(#{name})) > 0
        </if>
        AND deleted_at IS NULL
    </select>

    <update id="softDeleteById">
        UPDATE company
        SET deleted_at = SYSTIMESTAMP
        WHERE company_id = #{companyId}
          AND deleted_at IS NULL
    </update>

    <select id="isActiveById" resultType="boolean">
        SELECT CASE WHEN deleted_at IS NULL THEN 1 ELSE 0 END
        FROM company
        WHERE company_id = #{companyId}
    </select>

    <!-- 중복 검사 -->
    <select id="existsByBizNo" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM COMPANY
        WHERE biz_no = #{bizNo}
        <if test="excludeId != null">
            AND company_id != #{excludeId}
        </if>
        AND deleted_at IS NULL
    </select>

    <select id="existsByName" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM COMPANY
        WHERE LOWER(name) = LOWER(#{name})
        <if test="excludeId != null">
            AND company_id != #{excludeId}
        </if>
        AND deleted_at IS NULL
    </select>

    <select id="existsCompanyById" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM COMPANY
        WHERE company_id = #{companyId}
          AND deleted_at IS NULL
    </select>

    <!-- 회사 하위 엔터티 존재 여부 (하나라도 존재하면 true) -->
    <select id="existsRelationData" resultType="boolean">
        SELECT CASE
                   WHEN (
                       EXISTS (SELECT 1
                               FROM employee e
                               WHERE e.status = 'ACTIVE'
                                 AND e.company_id = #{companyId})
                           OR EXISTS (SELECT 1
                                      FROM item i
                                      WHERE i.deleted_at IS NULL
                                        AND i.company_id = #{companyId})
                           OR EXISTS (SELECT 1
                                      FROM stock s
                                      WHERE s.company_id = #{companyId})
                           OR EXISTS (SELECT 1
                                      FROM orders o
                                      WHERE o.company_id = #{companyId})
                           OR EXISTS (SELECT 1
                                      FROM purchase p
                                      WHERE p.company_id = #{companyId})
                           OR EXISTS (SELECT 1
                                      FROM inbound ib
                                      WHERE ib.company_id = #{companyId})
                           OR EXISTS (SELECT 1
                                      FROM outbound ob
                                      WHERE ob.company_id = #{companyId})
                       ) THEN 1
                   ELSE 0 END
        FROM dual
    </select>

</mapper>