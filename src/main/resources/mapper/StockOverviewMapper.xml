<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.report.stock.overview.mapper.StockOverviewMapper">

    <!-- 품목별 집계: 입고/출고/현재재고 -->
    <select id="findAllItemRowByMonth" resultType="StockOverviewItemRow">
        WITH inbound_agg AS (SELECT pi.item_id       AS item_id,
                                    SUM(pi.quantity) AS in_qty
                             FROM inbound ib
                                      JOIN purchase p ON p.purchase_id = ib.purchase_id
                                      JOIN purchase_item pi
                                           ON pi.purchase_id = p.purchase_id
                             WHERE ib.status = 'ACTIVE'
                               AND ib.inbound_date >= #{startDate}
                               AND #{endDate} >= ib.inbound_date
                             GROUP BY pi.item_id),
             outbound_agg AS (SELECT oi.item_id       AS item_id,
                                     SUM(oi.quantity) AS out_qty
                              FROM outbound ob
                                       JOIN orders o ON o.order_id = ob.order_id
                                       JOIN order_item oi ON oi.order_id = o.order_id
                              WHERE ob.status = 'ACTIVE'
                                AND ob.outbound_date >= #{startDate}
                                AND #{endDate} >= ob.outbound_date
                              GROUP BY oi.item_id)
        SELECT i.item_id                  AS itemId,
               i.name                     AS name,
               i.unit                     AS unit,
               NVL(ia.in_qty, 0)          AS inboundQuantity,
               NVL(oa.out_qty, 0)         AS outboundQuantity,
               NVL(s.on_hand_quantity, 0) AS onHandQuantity
        FROM item i
                 LEFT JOIN inbound_agg ia ON ia.item_id = i.item_id
                 LEFT JOIN outbound_agg oa ON oa.item_id = i.item_id
                 LEFT JOIN stock s ON s.item_id = i.item_id
        WHERE i.deleted_at IS NULL
        ORDER BY i.name ASC
    </select>


    <!-- 전년 동월: 입고 총수량 -->
    <select id="sumInboundQuantityByMonth" resultType="int">
        SELECT NVL(SUM(pi.quantity), 0)
        FROM inbound ib
                 JOIN purchase p ON p.purchase_id = ib.purchase_id
                 JOIN purchase_item pi ON pi.purchase_id = p.purchase_id
                 JOIN item i ON i.item_id = pi.item_id
        WHERE ib.status = 'ACTIVE'
          AND ib.inbound_date >= #{startDate}
          AND #{endDate} >= ib.inbound_date
          AND i.deleted_at IS NULL
    </select>


    <!-- 전년 동월: 출고 총수량 -->
    <select id="sumOutboundQuantityByMonth" resultType="int">
        SELECT NVL(SUM(oi.quantity), 0)
        FROM outbound ob
                 JOIN orders o ON o.order_id = ob.order_id
                 JOIN order_item oi ON oi.order_id = o.order_id
                 JOIN item i ON i.item_id = oi.item_id
        WHERE ob.status = 'ACTIVE'
          AND ob.outbound_date >= #{startDate}
          AND #{endDate} >= ob.outbound_date
          AND i.deleted_at IS NULL
    </select>

</mapper>
