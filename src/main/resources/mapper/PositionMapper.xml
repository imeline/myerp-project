<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.position.mapper.PositionMapper">

    <select id="nextId" resultType="long">
        SELECT POSITION_SEQ.NEXTVAL
        FROM DUAL
    </select>

    <insert id="save">
        INSERT INTO position (position_id, name, level_no, company_id)
        VALUES (#{position.positionId},
                #{position.name},
                #{position.levelNo},
                #{tenantId})
    </insert>

    <select id="findAll" parameterType="long" resultType="Position">
        SELECT position_id, name, level_no
        FROM position
        WHERE
        <include refid="frag.tenantGuard"/>
        ORDER BY level_no
    </select>

    <select id="findLastLevelNo" parameterType="long" resultType="int">
        SELECT NVL(MAX(level_no), 0)
        FROM position
        WHERE
        <include refid="frag.tenantGuard"/>
    </select>

    <select id="findLevelNoById" resultType="Integer">
        SELECT level_no
        FROM position
        WHERE position_id = #{positionId}
        AND
        <include refid="frag.tenantGuard"/>
    </select>

    <update id="updateNameById">
        UPDATE position
        SET name = #{name}
        WHERE position_id = #{positionId}
        AND
        <include refid="frag.tenantGuard"/>
    </update>

    <update id="updateLevelNoById">
        UPDATE position
        SET level_no = #{levelNo}
        WHERE position_id = #{positionId}
        AND
        <include refid="frag.tenantGuard"/>
    </update>

    <update id="shiftUpRange">
        UPDATE position
        SET level_no = level_no + 1
        WHERE level_no between #{newLevelNo} AND #{oldLevelNo} - 1
        AND
        <include refid="frag.tenantGuard"/>
    </update>

    <update id="shiftDownRange">
        UPDATE position
        SET level_no = level_no - 1
        WHERE level_no between #{oldLevelNo} + 1 AND #{newLevelNo}
        AND
        <include refid="frag.tenantGuard"/>
    </update>

    <delete id="deleteById">
        DELETE FROM position
        WHERE position_id = #{positionId}
        AND
        <include refid="frag.tenantGuard"/>
    </delete>

    <select id="existsByName" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM position
        WHERE LOWER(name) = LOWER(#{name})
        <if test="excludePositionId != null">
            AND position_id != #{excludePositionId}
        </if>
        AND
        <include refid="frag.tenantGuard"/>
    </select>

    <select id="existsById" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM position
        WHERE position_id = #{positionId}
        AND
        <include refid="frag.tenantGuard"/>
    </select>

</mapper>