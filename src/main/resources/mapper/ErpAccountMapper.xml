<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.account.mapper.ErpAccountMapper">

    <select id="nextId" resultType="long">
        SELECT erp_account_seq.NEXTVAL
        FROM dual
    </select>

    <insert id="save" parameterType="ErpAccount">
        INSERT INTO erp_account (erp_account_id, login_email,
                                 password, uuid, role,
                                 employee_id)
        VALUES (#{erpAccountId}, #{loginEmail},
                #{password}, #{uuid}, #{role},
                #{employeeId})
    </insert>

    <select id="existsByLoginEmail" parameterType="string" resultType="boolean">
        SELECT CASE
                   WHEN EXISTS (SELECT 1
                                FROM ERP_ACCOUNT a
                                WHERE a.login_email = #{loginEmail}
                                  AND a.deleted_at IS NULL)
                       THEN 1
                   ELSE 0 END
        FROM DUAL
    </select>

    <select id="findLoginRowByLoginEmail" parameterType="string"
            resultType="LoginUserInfoRow">
        SELECT a.uuid     AS uuid,
               a.role     AS role,
               a.password AS passwordHash,
               e.name     AS name
        FROM ERP_ACCOUNT a
                 JOIN EMPLOYEE e ON e.employee_id = a.employee_id
        WHERE a.login_email = #{loginEmail}
          AND a.deleted_at IS NULL
    </select>

    <update id="softDeleteByEmployeeId">
        UPDATE erp_account
        SET deleted_at = SYSTIMESTAMP
        WHERE employee_id = #{employeeId}
          AND deleted_at IS NULL
    </update>

</mapper>