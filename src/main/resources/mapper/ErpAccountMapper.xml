<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.auth.mapper.ErpAccountMapper">

    <select id="findByUuid" parameterType="string" resultType="ErpAccount">
        SELECT *
        FROM erp_account
        WHERE uuid = #{uuid}
    </select>

    <insert id="saveErpAccount" parameterType="ErpAccount">
        INSERT INTO erp_account (erp_account_id, login_email,
                                 password, uuid, role,
                                 updated_at, employee_id)
        VALUES (#{erpAccountId}, #{loginEmail},
                #{password}, #{uuid}, #{role},
                SYSTIMESTAMP, #{employeeId})
    </insert>

    <select id="getNextErpAccountId" resultType="Long">
        SELECT erp_account_seq.NEXTVAL
        FROM dual
    </select>

    <select id="existsByLoginEmail" parameterType="string" resultType="boolean">
        SELECT CASE
                   WHEN EXISTS (SELECT 1
                                FROM ERP_ACCOUNT a
                                WHERE a.LOGIN_EMAIL = #{loginEmail})
                       THEN 1
                   ELSE 0 END
        FROM DUAL
    </select>

    <select id="findLoginRowByEmail" parameterType="string"
            resultType="LoginRow">
        SELECT a.UUID      AS uuid,
               a.ROLE      AS role,
               a.PASSWORD  AS passwordHash,
               e.name      AS name,
               c.TENANT_ID AS tenantId
        FROM ERP_ACCOUNT a
                 JOIN EMPLOYEE e ON e.EMPLOYEE_ID = a.EMPLOYEE_ID
                 JOIN COMPANY c ON c.COMPANY_ID = e.COMPANY_ID
        WHERE a.LOGIN_EMAIL = #{loginEmail}
    </select>

</mapper>