<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="erp.department.mapper.DepartmentMapper">

    <sql id="tenantGuard">company_id = #{tenantId}</sql>
    <sql id="tenantGuardAlias">${alias}.company_id = #{tenantId}</sql>

    <select id="nextId" resultType="long">
        SELECT department_seq.NEXTVAL FROM dual
    </select>

    <insert id="create" parameterType="map">
        INSERT INTO DEPARTMENT (
            department_id, company_id, parent_id, name
        ) VALUES (
                     #{department.departmentId},
                     #{tenantId},
                     #{department.parentId},
                     #{department.name}
                 )
    </insert>

    <update id="update" parameterType="map">
        UPDATE DEPARTMENT
        SET name = #{department.name},
        parent_id = #{department.parentId}
        WHERE department_id = #{department.departmentId}
        AND <include refid="tenantGuard"/>
    </update>

    <select id="findById" parameterType="map" resultType="erp.department.domain.Department">
        SELECT dept.department_id AS departmentId,
        dept.name          AS name,
        dept.company_id    AS companyId,
        NVL(dept.parent_id, 0) AS parentId
        FROM DEPARTMENT dept
        WHERE dept.department_id = #{departmentId}
        AND <include refid="tenantGuardAlias">
        <property name="alias" value="dept"/>
    </include>
    </select>

    <select id="existsByName" parameterType="map" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM DEPARTMENT dept
        WHERE <include refid="tenantGuardAlias">
        <property name="alias" value="dept"/>
    </include>
        AND LOWER(dept.name) = LOWER(#{name})
        <if test="excludeDepartmentId != null">
            AND dept.department_id <> #{excludeDepartmentId}
        </if>
    </select>

    <select id="existsById" parameterType="map" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM DEPARTMENT dept
        WHERE <include refid="tenantGuardAlias">
        <property name="alias" value="dept"/>
    </include>
        AND dept.department_id = #{departmentId}
    </select>

    <select id="findRows" parameterType="map" resultType="erp.department.domain.Department">
        SELECT dept.department_id AS departmentId,
        dept.name          AS name,
        dept.company_id    AS companyId,
        NVL(dept.parent_id, 0) AS parentId
        FROM DEPARTMENT dept
        WHERE <include refid="tenantGuardAlias">
        <property name="alias" value="dept"/>
    </include>
        <if test="name != null and name != ''">
            AND INSTR(LOWER(dept.name), LOWER(#{name})) > 0
        </if>
        ORDER BY dept.department_id DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <select id="countByName" parameterType="map" resultType="long">
        SELECT COUNT(1)
        FROM DEPARTMENT dept
        WHERE <include refid="tenantGuardAlias">
        <property name="alias" value="dept"/>
    </include>
        <if test="name != null and name != ''">
            AND INSTR(LOWER(dept.name), LOWER(#{name})) > 0
        </if>
    </select>

    <delete id="deleteById" parameterType="map">
        DELETE FROM DEPARTMENT
        WHERE department_id = #{departmentId}
        AND <include refid="tenantGuard"/>
    </delete>

</mapper>
