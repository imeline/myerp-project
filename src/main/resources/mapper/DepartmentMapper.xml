<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="erp.department.mapper.DepartmentMapper">

    <select id="nextId" resultType="long">
        SELECT department_seq.NEXTVAL
        FROM dual
    </select>

    <!-- insert 시 tenant_id 검증은 삽입할 도메인에
    jwt 토큰에서 추출한 tenant_id를 넣어주므로 별도 검증 없음 -->
    <insert id="save">
        INSERT INTO DEPARTMENT (department_id, company_id, parent_id, name)
        VALUES (#{department.departmentId},
        #{tenantId},
        #{department.parentId, jdbcType=NUMERIC}, <!-- null 허용 -->
        #{department.name})
    </insert>

    <update id="updateById">
        UPDATE DEPARTMENT
        SET
        name = #{department.name},
        parent_id = #{department.parentId}
        WHERE department_id = #{department.departmentId}
        AND
        <include refid="frag.tenantGuard"/>
        <!-- 오라클은 비용 기반 최적화라서 AND 순서가 성능에 영향 없음 -->
    </update>

    <select id="findById" resultType="Department">
        SELECT
        department_id,
        company_id,
        parent_id,
        name
        FROM DEPARTMENT
        WHERE department_id = #{departmentId}
        AND
        <include refid="frag.tenantGuard"/>
    </select>

    <!-- 최상위(parent_id IS NULL) 목록 + 자식 존재 여부 -->
    <select id="findAllTopLevelDepartmentRow" resultType="DepartmentFindRow">
        SELECT
        department_id AS departmentId,
        name AS name,
        <!-- 자식 여부 0, 1 리턴 -->
        CASE WHEN EXISTS (
        SELECT 1  <!-- 존재 여부만 확인할 거라 관례적으로 1 같은 상수 -->
        FROM DEPARTMENT c
        WHERE
        <!-- 바깥 행(DEPARTMENT)이 부모이고, 그를 부모로 가진 자식(c)이 있는지 확인 -->
        c.parent_id = DEPARTMENT.department_id
        AND
        <include refid="frag.tenantGuard"/>
        ) THEN 1 ELSE 0 END AS hasChildren
        FROM DEPARTMENT
        WHERE
        DEPARTMENT.parent_id IS NULL
        AND
        <include refid="frag.tenantGuard"/>
        ORDER BY DEPARTMENT.department_id
    </select>

    <!-- 특정 부모의 직계 자식 + 자식 존재 여부 -->
    <select id="findAllDepartmentRowByParentId" resultType="DepartmentFindRow">
        SELECT
        department_id AS departmentId,
        name AS name,
        <!-- 자식 여부 0, 1 리턴 -->
        CASE WHEN EXISTS (
        SELECT 1  <!-- 존재 여부만 확인할 거라 관례적으로 1 같은 상수 -->
        FROM DEPARTMENT c
        WHERE
        <!-- 바깥 행(DEPARTMENT)이 부모이고, 그를 부모로 가진 자식(c)이 있는지 확인 -->
        c.parent_id = DEPARTMENT.department_id
        AND
        <include refid="frag.tenantGuard"/>
        ) THEN 1 ELSE 0 END AS hasChildren
        FROM DEPARTMENT
        WHERE
        DEPARTMENT.parent_id = #{parentId}
        AND
        <include refid="frag.tenantGuard"/>
        ORDER BY DEPARTMENT.department_id
    </select>

    <delete id="deleteById">
        DELETE FROM DEPARTMENT
        WHERE department_id = #{departmentId}
        AND
        <include refid="frag.tenantGuard"/>
    </delete>

    <!-- 같은 부모 아래 이름 중복 확인 (수정 시 자기 자신 제외) -->
    <select id="existsByNameAndParentId" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM DEPARTMENT
        WHERE
        LOWER(name) = LOWER(#{name})
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="parentId == null">
            AND parent_id IS NULL
        </if>
        <if test="excludeId != null">
            AND department_id != #{excludeId}
        </if>
        AND
        <include refid="frag.tenantGuard"/>
    </select>


    <select id="existsById" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM DEPARTMENT
        WHERE
        department_id = #{departmentId}
        AND
        <include refid="frag.tenantGuard"/>
    </select>

    <!-- 자식 존재 여부 -->
    <select id="existsChildById" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM DEPARTMENT
        WHERE
        parent_id = #{departmentId}
        AND
        <include refid="frag.tenantGuard"/>
    </select>


    <!-- 전체 부서 한번에 조회 (참고용: 필요 시 활성화) -->
    <!--
    <select id="findAllDepartmentRow" resultType="DepartmentRowResponse">
        SELECT
            d.department_id,
            d.name,
            d.parent_id,
            NVL(cc.cnt, 0) AS children_cnt
        FROM DEPARTMENT d
        부모별 자식 수를 미리 집계
        LEFT JOIN (
            SELECT c.parent_id, COUNT(1) AS cnt
            FROM DEPARTMENT c
            WHERE <include refid="frag.tenantGuardAlias">
                      <property name="alias" value="c"/>
                  </include>
            GROUP BY c.parent_id
        ) cc ON cc.parent_id = d.department_id
        WHERE <include refid="frag.tenantGuardAlias">
                  <property name="alias" value="d"/>
              </include>
        부모가 NULL인 행을 먼저
        ORDER BY NVL(d.parent_id, -1), d.department_id
    </select>
    -->

</mapper>
