<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="erp.department.mapper.DepartmentMapper">

    <select id="nextId" resultType="long">
        SELECT department_seq.NEXTVAL
        FROM dual
    </select>
    
    <insert id="save">
        INSERT INTO department (department_id, parent_id, name)
        VALUES (#{department.departmentId},
        #{department.parentId, jdbcType=NUMERIC}, <!-- null 허용 -->
        #{department.name})
    </insert>

    <update id="updateById">
        UPDATE department
        SET
        name = #{department.name},
        parent_id = #{department.parentId}
        WHERE department_id = #{department.departmentId}
        <!-- 오라클은 비용 기반 최적화라서 AND 순서가 성능에 영향 없음 -->
    </update>

    <select id="findById" resultType="Department">
        SELECT department_id,
               parent_id,
               name
        FROM department
        WHERE department_id = #{departmentId}
    </select>

    <!-- 최상위(parent_id IS NULL) 목록 + 자식 존재 여부 -->
    <select id="findAllTopLevelDepartmentRow" resultType="DepartmentFindRow">
        SELECT
        department_id AS departmentId,
        name AS name,
        <!-- 자식 여부 0, 1 리턴 -->
        CASE WHEN EXISTS (
        SELECT 1  <!-- 존재 여부만 확인할 거라 관례적으로 1 같은 상수 -->
        FROM department c
        WHERE
        <!-- 바깥 행(DEPARTMENT)이 부모이고, 그를 부모로 가진 자식(c)이 있는지 확인 -->
        c.parent_id = DEPARTMENT.department_id
        ) THEN 1 ELSE 0 END AS hasChildren
        FROM department
        WHERE
        department.parent_id IS NULL
        ORDER BY department.department_id
    </select>

    <!-- 특정 부모의 직계 자식 + 자식 존재 여부 -->
    <select id="findAllDepartmentRowByParentId" resultType="DepartmentFindRow">
        SELECT
        department_id AS departmentId,
        name AS name,
        <!-- 자식 여부 0, 1 리턴 -->
        CASE WHEN EXISTS (
        SELECT 1  <!-- 존재 여부만 확인할 거라 관례적으로 1 같은 상수 -->
        FROM department c
        WHERE
        <!-- 바깥 행(DEPARTMENT)이 부모이고, 그를 부모로 가진 자식(c)이 있는지 확인 -->
        c.parent_id = DEPARTMENT.department_id
        ) THEN 1 ELSE 0 END AS hasChildren
        FROM department
        WHERE
        department.parent_id = #{parentId}
        ORDER BY department.department_id
    </select>

    <delete id="deleteById">
        DELETE
        FROM department
        WHERE department_id = #{departmentId}
    </delete>

    <!-- 같은 부모 아래 이름 중복 확인 (수정 시 자기 자신 제외) -->
    <select id="existsByNameAndParentId" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM department
        WHERE
        LOWER(name) = LOWER(#{name})
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="parentId == null">
            AND parent_id IS NULL
        </if>
        <if test="excludeId != null">
            AND department_id != #{excludeId}
        </if>
    </select>


    <select id="existsById" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM department
        WHERE department_id = #{departmentId}
    </select>

    <!-- 자식 존재 여부 -->
    <select id="existsChildById" resultType="boolean">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM department
        WHERE parent_id = #{departmentId}
    </select>

</mapper>
