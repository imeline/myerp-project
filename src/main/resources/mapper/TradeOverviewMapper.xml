<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.report.trade.overview.mapper.TradeOverviewMapper">

    <!-- 월별 매출/매입 합계
         - 주문금액, 발주금액 두 집계를 UNION ALL 후 월 단위로 SUM -->
    <select id="findAllMonthlyOrderPurchaseAmountRow"
            resultType="TradeOverviewMonthlyAmountRow">
        SELECT
            month AS month, SUM (order_amount) AS orderAmount, SUM (purchase_amount) AS purchaseAmount
        FROM (
            SELECT
            EXTRACT (MONTH FROM ob.outbound_date) AS month, SUM (o.total_amount) AS order_amount, 0 AS purchase_amount
            FROM outbound ob
            JOIN orders o
            ON o.order_id = ob.order_id
            WHERE ob.status = 'ACTIVE'
            AND ob.outbound_date >= #{startDate}
            AND #{endDate} >= ob.outbound_date
            GROUP BY EXTRACT (MONTH FROM ob.outbound_date)
            UNION ALL
            SELECT
            EXTRACT (MONTH FROM ib.inbound_date) AS month, 0 AS order_amount, SUM (p.total_amount) AS purchase_amount
            FROM inbound ib
            JOIN purchase p
            ON p.purchase_id = ib.purchase_id
            WHERE ib.status = 'ACTIVE'
            AND ib.inbound_date >= #{startDate}
            AND #{endDate} >= ib.inbound_date
            GROUP BY EXTRACT (MONTH FROM ib.inbound_date)
            )
        GROUP BY month
        ORDER BY month
    </select>

    <!-- 기간 주문 총액 (출고일 기준, ACTIVE 출고만) -->
    <select id="sumOrderAmountByPeriod" resultType="int">
        SELECT NVL(SUM(o.total_amount), 0)
        FROM outbound ob
                 JOIN orders o
                      ON o.order_id = ob.order_id
        WHERE ob.status = 'ACTIVE'
          AND ob.outbound_date >= #{startDate}
          AND #{endDate} >= ob.outbound_date
    </select>

    <!-- 기간 매입 총액 (입고일 기준, ACTIVE 입고만) -->
    <select id="sumPurchaseAmountByPeriod" resultType="int">
        SELECT NVL(SUM(p.total_amount), 0)
        FROM inbound ib
                 JOIN purchase p
                      ON p.purchase_id = ib.purchase_id
        WHERE ib.status = 'ACTIVE'
          AND ib.inbound_date >= #{startDate}
          AND #{endDate} >= ib.inbound_date
    </select>

</mapper>
